<html>
  <header>
    <title>SurferBot API Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </header>
  <body>
    <table class="table" id="myTable">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">growID</th>
          <th scope="col">Status</th>
          <th scope="col">World</th>
          <th scope="col">Ping</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <script src="script.js"></script>
  </body>
</html>

const ServerUrl = "127.0.0.1";
const serverPassword = "2FuB7";

function isJsonString(str) {
  try {
    JSON.parse(str);
    return true;
  } catch (e) {
    return false;
  }
}

async function requestAPI(path, data) {

    const formData = new FormData();
    for (const key in data) {
      formData.append(key, data[key]);
    }

    const response = await fetch(`http://${ServerUrl}:4545/${path}`, {
    method: "POST",
    headers: {
      "password": serverPassword,
    },
    body: formData
  });

  const responseText = await response.text();
  return isJsonString(responseText) ? JSON.parse(responseText) : responseText;
}

const BotStatus = [
  "Disconnected",
  "Connected",
  "Banned",
  "Suspended",
  "Wrong Password",
  "Update Required",
  "Maintenance",
  "AAP",
  "Logon ATTEMPTS",
  "On Send To Server",
  "Captcha",
  "Success",
  "SERVER OVERLOADED",
  "Bypass Tutorial",
];

async function updateList() {
  const response1 = await requestAPI("runScript", {
    script: `
      for k, v in pairs(getAllBot) do
        ping = v:getMs()
        world = v:getCurrentWorld()
        status = v:getBotStatus()
        growid = v:getLocal().name
        print(growid .. "|" .. status .. "|" .. world .. "|" .. ping)
      end
    `
  });

await new Promise(resolve => setTimeout(resolve, 100));

const response2 = await requestAPI("getOutput", {
    scriptID: response1.scriptID
 });

const output = response2.split("\n");
const parsedData = output.map(item => {
    const [growID, status, world, ping] = item.split("|");
    if (growID === "") {
      return null;
    }
    return { growID, status, world, ping };
}).filter(item => item !== null);

const table = document.getElementById("myTable");
const tbody = table.querySelector("tbody");
tbody.innerHTML = "";

parsedData.forEach((data, i) => {
  const row = document.createElement("tr");
  
  row.appendChild(document.createElement("td")).textContent = i;
  row.appendChild(document.createElement("td")).textContent = data.growID;
  row.appendChild(document.createElement("td")).textContent = BotStatus[data.status];
  row.appendChild(document.createElement("td")).textContent = data.world;
  row.appendChild(document.createElement("td")).textContent = data.ping;

  const cell6 = document.createElement("td");
  cell6.innerHTML = `<button onclick="warp('${data.growID}')" type="button">Warp</button>`;
  row.appendChild(cell6);

  tbody.appendChild(row);
});
}

function warp(botName) {
  const worldName = prompt("Please enter the World Name");
  RequestAPI("runScript", {
    script: `getBot('${botName}'):warp('${worldName}')`,
  });
}

updateList();
setInterval(updateList, 1000);
